<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MP4 → frame.txt (128x64)</title>

  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col items-center p-6">

  <div class="bg-white p-8 rounded-xl shadow max-w-2xl w-full">
    <h1 class="text-2xl font-bold text-center mb-4">MP4 → frame.txt Converter</h1>

    <input type="file" id="mp4Input" accept="video/mp4" class="mb-4">

    <button id="startBtn"
      class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg">
      Convert Video
    </button>

    <canvas id="cvs" width="128" height="64" class="mt-6 border mx-auto"></canvas>

    <pre id="log" class="mt-6 bg-gray-50 border p-4 rounded h-60 overflow-y-auto text-xs"></pre>
  </div>

  <script type="module">
    import { createFFmpeg, fetchFile } from 
      "https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.6/dist/esm/ffmpeg.min.js";

    const logBox = document.getElementById("log");
    const log = (t) => (logBox.textContent += t + "\n");

    const ffmpeg = createFFmpeg({
      log: false,
      corePath:
        "https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.6/dist/esm/ffmpeg-core.js",
    });

    document.getElementById("startBtn").onclick = async () => {
      const file = document.getElementById("mp4Input").files[0];
      if (!file) return alert("Upload MP4 dulu!");

      logBox.textContent = "Loading FFmpeg...";
      await ffmpeg.load();

      log("Uploading video...");
      ffmpeg.FS("writeFile", "input.mp4", await fetchFile(file));

      log("Extracting frames (fps=10)...");
      await ffmpeg.run(
        "-i",
        "input.mp4",
        "-vf",
        "fps=10",
        "frame_%03d.png"
      );

      const canvas = document.getElementById("cvs");
      const ctx = canvas.getContext("2d");

      let output = "";
      let i = 1;

      while (true) {
        const fname = `frame_${String(i).padStart(3, "0")}.png`;

        try {
          const bin = ffmpeg.FS("readFile", fname);
          log(`Process ${fname}`);

          const img = await createImageBitmap(
            new Blob([bin.buffer], { type: "image/png" })
          );

          ctx.drawImage(img, 0, 0, 128, 64);
          const data = ctx.getImageData(0, 0, 128, 64).data;

          let bytes = [];
          let byte = 0,
            bit = 0;

          for (let p = 0; p < data.length; p += 4) {
            const gray = (data[p] + data[p + 1] + data[p + 2]) / 3;
            const bitVal = gray < 128 ? 1 : 0;

            byte = (byte << 1) | bitVal;
            bit++;

            if (bit === 8) {
              bytes.push(byte);
              byte = 0;
              bit = 0;
            }
          }

          output += `// 'frame${i}', 128x64px\n`;
          for (let j = 0; j < bytes.length; j++) {
            if (j % 16 === 0) output += "\n";
            output += "0x" + bytes[j].toString(16).padStart(2, "0") + ", ";
          }

          output += "\n\n";
        } catch {
          break; // end of frames
        }

        i++;
      }

      log("Generating frame.txt...");
      const blob = new Blob([output], { type: "text/plain" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "frame.txt";
      link.click();

      log("Done ✓");
    };
  </script>
</body>
</html>
